from flask import Flask, jsonify, request
from flask_cors import CORS
from data import pull_data, get_risk_free_rate, calculate_returns
from portfolio import Portfolio
from benchmark import Benchmark
import pandas as pd

app = Flask(__name__)
CORS(app)

#Initial test method
@app.route('/', methods=['GET'])
def hello_world():
    return 'Hello World'

#Take in information from user:
#List of assets
#Start date
#End date
@app.route('/api/info', methods=['POST']) 
def parse_info():   
    
    stocks = request.get_json()['assets']
    benchmark = request.get_json()['benchmark']
    start_date = pd.to_datetime(request.get_json()['start_date']) #Datetime object
    end_date = pd.to_datetime(request.get_json()['end_date'])
    frequency = request.get_json()['frequency']
    transaction_costs = request.get_json()['transaction_costs'] #0 or 1

    #Initial data pull
    results = pull_data(stocks, start_date, end_date) 
    benchmark_results = pull_data(benchmark, start_date, end_date)

    #Get daily and annual risk free rate
    interest_rates = get_risk_free_rate(start_date,end_date)

    #Calculate log returns
    return_dict = calculate_returns(results['stock_dict'])
    benchmark_return_dict = calculate_returns(benchmark_results['stock_dict'])

    #Output for the portfolio
    portfolio = Portfolio(start_date, end_date, return_dict, interest_rates, frequency, transaction_costs)
    output = portfolio.optimize_portfolio()

    #Output for the benchmark
    benchmark = Benchmark(benchmark_return_dict,benchmark)
    benchmark_output = benchmark.form_returns()

    #BELOW THIS LINE IS USED FOR TESTING ON LOCALHOST

    return jsonify({"optimized_returns": output['optimized_returns'],
                   "optimized_weights": output['optimized_weights'],
                   "benchmark_returns": benchmark_output['benchmark_monthly_returns'],
                   "benchmark_cumulative_returns": benchmark_output['benchmark_cumulative_returns']
                     })
    
@app.route('/api/test', methods=['GET']) 
def test_info():
    
    return jsonify({
    "optimized_returns": {
        "2015-03-03": 0.03185614904524844,
        "2015-03-31": 0.04124718260427429,
        "2015-04-30": 0.041640751351339655,
        "2015-05-31": 0.03495227114856054,
        "2015-06-30": 0.048462630897680145,
        "2015-07-31": -0.06733060761276075,
        "2015-08-31": -0.15101656197872526,
        "2015-09-30": 0.042636365162456946,
        "2015-10-31": 0.031670412508857416,
        "2015-11-30": 0.04836959234387939,
        "2015-12-31": 0.035997801387249714,
        "2016-01-31": 0.031642815910603445,
        "2016-02-29": 0.027687019791425172
    },
    "optimized_weights": {
        "2015-03-03": [
            [
                "IBB",
                -3.465048005510497e-9,
                "-0.000%"
            ],
            [
                "IHE",
                0.4124459749104502,
                "41.245%"
            ],
            [
                "IVV",
                -1.0884524031216988e-7,
                "-0.000%"
            ],
            [
                "IYC",
                -2.0924056196698997e-8,
                "-0.000%"
            ],
            [
                "IYE",
                -8.92593622660526e-9,
                "-0.000%"
            ],
            [
                "IYF",
                -5.617539621084168e-9,
                "-0.000%"
            ],
            [
                "IYH",
                -1.865818692612191e-8,
                "-0.000%"
            ],
            [
                "IYJ",
                -7.620719590768168e-8,
                "-0.000%"
            ],
            [
                "IYW",
                -0.587554469239871,
                "-58.755%"
            ]
        ],
        "2015-03-31": [
            [
                "IBB",
                -0.00003437416485208331,
                "-0.003%"
            ],
            [
                "IHE",
                -7.445080493335681e-8,
                "-0.000%"
            ],
            [
                "IVV",
                -5.049028458853157e-7,
                "-0.000%"
            ],
            [
                "IYC",
                2.0552233641536675e-8,
                "0.000%"
            ],
            [
                "IYE",
                0.5068169464381795,
                "50.682%"
            ],
            [
                "IYF",
                -1.0210437489603844e-8,
                "-0.000%"
            ],
            [
                "IYH",
                -0.2835517351464277,
                "-28.355%"
            ],
            [
                "IYJ",
                -0.19445571184895316,
                "-19.446%"
            ],
            [
                "IYW",
                0.015140648645244085,
                "1.514%"
            ]
        ],
        "2015-04-30": [
            [
                "IBB",
                0.26282896431658287,
                "26.283%"
            ],
            [
                "IHE",
                -0.1058440309256507,
                "-10.584%"
            ],
            [
                "IVV",
                -0.000017394269088297133,
                "-0.002%"
            ],
            [
                "IYC",
                -0.0000017591066320487386,
                "-0.000%"
            ],
            [
                "IYE",
                -0.488608746521849,
                "-48.861%"
            ],
            [
                "IYF",
                -0.000005967978997338485,
                "-0.001%"
            ],
            [
                "IYH",
                0.10545382986644873,
                "10.545%"
            ],
            [
                "IYJ",
                -0.03723884341707933,
                "-3.724%"
            ],
            [
                "IYW",
                -4.6359791304782935e-7,
                "-0.000%"
            ]
        ],
        "2015-05-31": [
            [
                "IBB",
                0.29874349430376884,
                "29.874%"
            ],
            [
                "IHE",
                -9.370448331035404e-10,
                "-0.000%"
            ],
            [
                "IVV",
                -2.5957981333712473e-7,
                "-0.000%"
            ],
            [
                "IYC",
                4.5824368870556785e-8,
                "0.000%"
            ],
            [
                "IYE",
                -0.01075981491163441,
                "-1.076%"
            ],
            [
                "IYF",
                6.483511419143388e-9,
                "0.000%"
            ],
            [
                "IYH",
                1.5797363540420976e-8,
                "0.000%"
            ],
            [
                "IYJ",
                -3.782045701253644e-8,
                "-0.000%"
            ],
            [
                "IYW",
                -0.6904966513421507,
                "-69.050%"
            ]
        ],
        "2015-06-30": [
            [
                "IBB",
                0.09041182738109226,
                "9.041%"
            ],
            [
                "IHE",
                -7.06695783093295e-10,
                "-0.000%"
            ],
            [
                "IVV",
                -0.000002230596473142918,
                "-0.000%"
            ],
            [
                "IYC",
                0.495669199589382,
                "49.567%"
            ],
            [
                "IYE",
                -0.21943858893607351,
                "-21.944%"
            ],
            [
                "IYF",
                -0.000004463701691579228,
                "-0.000%"
            ],
            [
                "IYH",
                0.0000020253691397842785,
                "0.000%"
            ],
            [
                "IYJ",
                -0.19444940849378584,
                "-19.445%"
            ],
            [
                "IYW",
                0.000022258185655441703,
                "0.002%"
            ]
        ],
        "2015-07-31": [
            [
                "IBB",
                -1.2015280304345748e-7,
                "-0.000%"
            ],
            [
                "IHE",
                -3.967124804662245e-8,
                "-0.000%"
            ],
            [
                "IVV",
                -1.1643076483739503e-7,
                "-0.000%"
            ],
            [
                "IYC",
                1.5344240272843442e-7,
                "0.000%"
            ],
            [
                "IYE",
                1,
                "100.000%"
            ],
            [
                "IYF",
                -1.0136624821713357e-7,
                "-0.000%"
            ],
            [
                "IYH",
                -7.037596250584927e-9,
                "-0.000%"
            ],
            [
                "IYJ",
                -3.2812996089333067e-10,
                "-0.000%"
            ],
            [
                "IYW",
                -2.153849762136187e-9,
                "-0.000%"
            ]
        ],
        "2015-08-31": [
            [
                "IBB",
                0.9315327704018044,
                "93.153%"
            ],
            [
                "IHE",
                0.0674772593358858,
                "6.748%"
            ],
            [
                "IVV",
                -0.00006267082079081179,
                "-0.006%"
            ],
            [
                "IYC",
                0.00001533437666030885,
                "0.002%"
            ],
            [
                "IYE",
                -0.0000017949322068159076,
                "-0.000%"
            ],
            [
                "IYF",
                0.0000015778627787043156,
                "0.000%"
            ],
            [
                "IYH",
                0.000001709992761488507,
                "0.000%"
            ],
            [
                "IYJ",
                0.0004474238610687179,
                "0.045%"
            ],
            [
                "IYW",
                0.00045945841603731624,
                "0.046%"
            ]
        ],
        "2015-09-30": [
            [
                "IBB",
                -0.025891619189281363,
                "-2.589%"
            ],
            [
                "IHE",
                -0.26955479386414627,
                "-26.955%"
            ],
            [
                "IVV",
                -8.220495860534418e-10,
                "-0.000%"
            ],
            [
                "IYC",
                -1.192802141925441e-7,
                "-0.000%"
            ],
            [
                "IYE",
                0.027644323348822452,
                "2.764%"
            ],
            [
                "IYF",
                -0.027535410746117723,
                "-2.754%"
            ],
            [
                "IYH",
                0.42202372216393585,
                "42.202%"
            ],
            [
                "IYJ",
                4.1268718751705894e-8,
                "0.000%"
            ],
            [
                "IYW",
                0.22735034250807448,
                "22.735%"
            ]
        ],
        "2015-10-31": [
            [
                "IBB",
                1.5952226407128142e-9,
                "0.000%"
            ],
            [
                "IHE",
                0.7760547344731958,
                "77.605%"
            ],
            [
                "IVV",
                -2.5816971039690116e-7,
                "-0.000%"
            ],
            [
                "IYC",
                -5.104775108497504e-8,
                "-0.000%"
            ],
            [
                "IYE",
                -0.09239942387038995,
                "-9.240%"
            ],
            [
                "IYF",
                0.00002558562847841016,
                "0.003%"
            ],
            [
                "IYH",
                -0.1315187950777447,
                "-13.152%"
            ],
            [
                "IYJ",
                -8.96601787378199e-7,
                "-0.000%"
            ],
            [
                "IYW",
                -2.53535719733992e-7,
                "-0.000%"
            ]
        ],
        "2015-11-30": [
            [
                "IBB",
                -5.102213508269361e-7,
                "-0.000%"
            ],
            [
                "IHE",
                0.294515320749416,
                "29.452%"
            ],
            [
                "IVV",
                -0.00391000918342462,
                "-0.391%"
            ],
            [
                "IYC",
                -0.000010370972333574015,
                "-0.001%"
            ],
            [
                "IYE",
                -0.4190666261190159,
                "-41.907%"
            ],
            [
                "IYF",
                -0.005901177932276198,
                "-0.590%"
            ],
            [
                "IYH",
                0.10642794608349335,
                "10.643%"
            ],
            [
                "IYJ",
                -0.020797409145333862,
                "-2.080%"
            ],
            [
                "IYW",
                -0.14937062958725222,
                "-14.937%"
            ]
        ],
        "2015-12-31": [
            [
                "IBB",
                -0.22646791629317822,
                "-22.647%"
            ],
            [
                "IHE",
                4.05514910269381e-8,
                "0.000%"
            ],
            [
                "IVV",
                7.841413569970862e-9,
                "0.000%"
            ],
            [
                "IYC",
                -6.723096335825364e-8,
                "-0.000%"
            ],
            [
                "IYE",
                0.04394872947481831,
                "4.395%"
            ],
            [
                "IYF",
                -0.26516803315169357,
                "-26.517%"
            ],
            [
                "IYH",
                0.349384438890963,
                "34.938%"
            ],
            [
                "IYJ",
                2.3207449954717147e-8,
                "0.000%"
            ],
            [
                "IYW",
                0.11503090122171213,
                "11.503%"
            ]
        ],
        "2016-01-31": [
            [
                "IBB",
                -0.15797258515671186,
                "-15.797%"
            ],
            [
                "IHE",
                -0.03559503510873923,
                "-3.560%"
            ],
            [
                "IVV",
                -1.6653352046560414e-7,
                "-0.000%"
            ],
            [
                "IYC",
                0.004079744825682165,
                "0.408%"
            ],
            [
                "IYE",
                -0.04613708131047048,
                "-4.614%"
            ],
            [
                "IYF",
                -0.19720688468167444,
                "-19.721%"
            ],
            [
                "IYH",
                9.62871023783721e-10,
                "0.000%"
            ],
            [
                "IYJ",
                0.5590087846059838,
                "55.901%"
            ],
            [
                "IYW",
                -4.2112543390041564e-8,
                "-0.000%"
            ]
        ],
        "2016-02-29": [
            [
                "IBB",
                -0.17331308414769042,
                "-17.331%"
            ],
            [
                "IHE",
                -0.00308733969224871,
                "-0.309%"
            ],
            [
                "IVV",
                0.35782299771858866,
                "35.782%"
            ],
            [
                "IYC",
                0.21754732510496924,
                "21.755%"
            ],
            [
                "IYE",
                0.10600144015942392,
                "10.600%"
            ],
            [
                "IYF",
                -0.14222501650910982,
                "-14.223%"
            ],
            [
                "IYH",
                -2.3324364022998934e-7,
                "-0.000%"
            ],
            [
                "IYJ",
                -0.0000025704479781656006,
                "-0.000%"
            ],
            [
                "IYW",
                -1.0267093101246219e-8,
                "-0.000%"
            ]
        ]
    }
})
#For testing
#if __name__ == "__main__":
#	app.run(debug=True, port=8080)

#For Production
if __name__ == "__main__":
	app.run(debug=True, host='0.0.0.0', port=8080)